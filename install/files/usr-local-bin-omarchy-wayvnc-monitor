#!/bin/bash
# wayvnc Display Attachment Monitor
# Shared system script (runs as root via systemd service)
# Continuously keeps wayvnc attached to the currently active Wayland display
# Follows user login/logout: greeter Sway on boot, user's Hyprland after login
# On VNC disconnect: automatically re-attaches to current active display

# Don't use set -e - we want the script to continue even if commands fail
# set -e

# Ensure greeter Sway is running and attach wayvnc to it
# If greeter is not running, launch it
ensure_greeter_and_attach() {
  # Check for greeter Sway (running as root)
  GREETER_PID=$(pgrep -u root "sway" 2>/dev/null | head -1)
  echo "DEBUG: Checking for greeter. Found PID: $GREETER_PID" >&2

  # If greeter not running, launch it
  if [[ -z "$GREETER_PID" ]]; then
    echo "DEBUG: Greeter not running, launching greetd..." >&2
    systemctl start greetd 2>&1
    sleep 2  # Give greeter time to start
    GREETER_PID=$(pgrep -u root "sway" 2>/dev/null | head -1)
    echo "DEBUG: After launch, greeter PID: $GREETER_PID" >&2
  fi

  if [[ -n "$GREETER_PID" ]]; then
    # Greeter is running - get greeter's Wayland socket
    RUNTIME_DIR="/run/user/0"  # root's runtime dir
    SOCKET="$RUNTIME_DIR/wayland-1"
    echo "DEBUG: Trying to attach to greeter socket: $SOCKET" >&2

    if [[ -S "$SOCKET" ]]; then
      echo "DEBUG: Socket exists, attempting attach..." >&2
      wayvncctl --socket /tmp/wayvncctl-0 attach "$SOCKET" 2>&1 && {
        echo "DEBUG: Successfully attached to greeter: $SOCKET" >&2
        return 0
      }
      echo "DEBUG: Attach to greeter failed for $SOCKET" >&2
    else
      echo "DEBUG: Greeter socket does not exist: $SOCKET" >&2
    fi
  fi

  echo "DEBUG: Could not attach to greeter, wayvnc remains detached" >&2
  return 1
}

# Attach wayvnc to currently active user Hyprland or greeter
# Priority: 1) User Hyprland (if logged in), 2) Greeter Sway
attach_to_current_display() {
  # Check for active user Hyprland (any non-root user with hyprland running)
  ACTIVE_USER=$(ps aux | grep "[h]yprland" | awk '{print $1}' | grep -v root | head -1)
  echo "DEBUG: Checking for active user Hyprland. Found: $ACTIVE_USER" >&2

  if [[ -n "$ACTIVE_USER" ]]; then
    # User is logged in - get their Wayland socket
    RUNTIME_DIR="/run/user/$(id -u "$ACTIVE_USER")"
    SOCKET="$RUNTIME_DIR/wayland-1"
    echo "DEBUG: Trying to attach to user Hyprland socket: $SOCKET" >&2

    if [[ -S "$SOCKET" ]]; then
      echo "DEBUG: Socket exists, attempting attach..." >&2
      wayvncctl --socket /tmp/wayvncctl-0 attach "$SOCKET" 2>&1 && {
        echo "DEBUG: Successfully attached to user Hyprland: $SOCKET" >&2
        return 0
      }
      echo "DEBUG: Attach to user Hyprland failed for $SOCKET" >&2
    else
      echo "DEBUG: User socket does not exist: $SOCKET" >&2
    fi
  fi

  # Fall back to greeter if no user logged in
  echo "DEBUG: No user logged in, falling back to greeter" >&2
  ensure_greeter_and_attach
}

# Lock screen on VNC client disconnect
handle_disconnect() {
  # Find the user with active Hyprland session
  ACTIVE_USER=$(ps aux | grep "[h]yprland" | awk '{print $1}' | grep -v root | head -1)
  echo "DEBUG: Found active user: $ACTIVE_USER" >&2

  if [[ -n "$ACTIVE_USER" ]]; then
    # Get session with SEAT value (graphical session) for this user
    # loginctl columns: SESSION UID USER SEAT LEADER CLASS TTY
    # We want: user=$ACTIVE_USER AND SEAT!="" (not "-")
    SESSION_ID=$(loginctl list-sessions --no-legend | awk -v user="$ACTIVE_USER" '$3==user && $4!="" && $4!="-" {print $1; exit}')

    echo "DEBUG: Found session $SESSION_ID for user $ACTIVE_USER" >&2

    if [[ -n "$SESSION_ID" ]]; then
      echo "DEBUG: Locking session $SESSION_ID for user $ACTIVE_USER" >&2
      LOCK_OUTPUT=$(loginctl lock-session "$SESSION_ID" 2>&1)
      LOCK_EXIT=$?
      echo "DEBUG: loginctl lock-session exit code: $LOCK_EXIT, output: $LOCK_OUTPUT" >&2
    else
      echo "DEBUG: Could not find graphical session for user $ACTIVE_USER" >&2
    fi
  fi

  # Detach wayvnc from the locked user display so reconnect can show greeter
  echo "DEBUG: Detaching wayvnc from locked display" >&2
  wayvncctl --socket /tmp/wayvncctl-0 detach 2>&1 || true
}

# Main loop: monitor wayvnc events and keep display attachment current
echo "Starting wayvnc display attachment monitor..." >&2

while true; do
  # Start event monitoring with reconnect logic
  # The --wait and --reconnect flags make wayvncctl wait and reconnect if wayvnc restarts
  # Note: --reconnect will spam errors if wayvnc is down, but that's acceptable
  wayvncctl --wait --reconnect --json event-receive 2>/dev/null | while read -r event; do
    # Only process if we got an actual event
    if [[ -z "$event" ]]; then
      continue
    fi

    # Detect client disconnect - lock screen and detach, then ensure greeter is running
    if echo "$event" | grep -q '"method":"client-disconnected"'; then
      echo "DEBUG: VNC client disconnected" >&2
      handle_disconnect
      sleep 1  # Wait for display state to stabilize after disconnect
      # Ensure greeter is available for reconnect
      ensure_greeter_and_attach || true
    fi

    # On client connect, attach to appropriate display (user desktop or greeter)
    if echo "$event" | grep -q '"method":"client-connected"'; then
      echo "DEBUG: VNC client connected" >&2
      attach_to_current_display || true
    fi
  done

  # If event-receive exits (wayvnc crashed or restarted), wait and retry
  sleep 2
  echo "Reconnecting to wayvnc..." >&2
done
